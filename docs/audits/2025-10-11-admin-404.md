# Admin SPA fallback regression analysis (2025-10-11)

## Summary
- `https://tooltician.com/admin` still responds with GitHub's default 404 document instead of the custom SPA fallback shipped in [`public/404.html`](../../public/404.html).【071991†L1-L12】【898171†L1-L80】
- The production host is missing `redirect-spa.js` and `spa-404.js`, confirming that the latest fallback bundle was never published to GitHub Pages.【39af22†L1-L12】【db1748†L1-L12】
- GitHub Actions job `Verify production routing` was introduced in commit [`99ad552`](https://github.com/cortega26/portfolio-manager-server/commit/99ad55285556f36276b375d3d08b66fd992665ea) and amended in [`c0e8614`](https://github.com/cortega26/portfolio-manager-server/commit/c0e8614593e94f8cdd729054c767db78b35ca661). It now gates the entire workflow on `curl https://www.tooltician.com/admin | grep -q "tooltician:spa:redirect"`.【85cb18†L8-L12】
- Because production is still serving the legacy 404, that step always exits with status 1,【a6b12e†L1-L3】 causing `ci.yml` to fail. The deploy workflow (`deploy.yml`) is configured with `needs: [ci]`, so Pages never receives the new fallback build.【38151a†L18-L47】

## Root cause
The regression is not in the fallback implementation itself; the new assets simply never reached the CDN. By asserting the *current* production response before the deployment step runs, CI deadlocks: the health check requires the new 404 to be live, but the deploy job that would publish that file is skipped whenever the check fails.

## Remediation (2025-10-12)
The CI/CD pipeline has been updated to break the deadlock:

1. **Local artifact validation.** The `CI` workflow now builds the static bundle, installs Playwright browsers, and runs `e2e/admin-routing.spec.ts` against the generated `dist/` directory via a lightweight HTTP server. This guarantees that the fallback assets ship with the review build before deployment.【F:.github/workflows/ci.yml†L38-L57】【F:playwright.static.config.ts†L1-L39】
2. **Post-deploy smoke check.** After Pages publishes a build, the deployment workflow polls `${{ steps.deployment.outputs.page_url }}/admin` until the `tooltician:spa:redirect` marker appears, failing only when the new fallback is still missing after ten attempts.【F:.github/workflows/deploy.yml†L51-L74】

With the health check decoupled from production, the next successful run of `deploy.yml` republishes the SPA fallback and `/admin` loads without a 404.
